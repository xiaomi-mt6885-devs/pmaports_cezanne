pkgname=devicepkg-dev
pkgver=0.12.4
pkgrel=0
pkgdesc="Provides default device package functions"
url="https://postmarketos.org"
arch="all"
license="MIT"
depends="diffconfig mergeconfig postmarketos-splash"
source="
	compiler-gcc.h
	devicepkg_build.sh
	devicepkg_package.sh
	downstreamkernel_prepare.sh
	downstreamkernel_package.sh
	devicepkg_subpackage_kernel.sh
	fragment_prepare.sh
	testdata/deviceinfo
	testdata/expected-deviceinfo-downstream
	testdata/expected-deviceinfo-mainline
"

check() {
	# Prepare a temporary dir to run the tests
	testdir=$(mktemp -d)
	install -Dm644 "$srcdir/deviceinfo" \
		"$testdir/src/deviceinfo"

	# Execute the script to create the subpackage deviceinfo
	sh devicepkg_subpackage_kernel.sh \
		$testdir linux-test linux-test-kernel-downstream
	sh devicepkg_subpackage_kernel.sh \
		$testdir linux-test linux-test-kernel-mainline

	# Compare the result with the expected files
	if ! cmp -s "$srcdir/expected-deviceinfo-downstream" \
		"$testdir/pkg/linux-test-kernel-downstream/etc/deviceinfo"; then
		echo "ERROR: unexpected result with downstream deviceinfo"
		exit 1
	fi
	if ! cmp -s "$srcdir/expected-deviceinfo-mainline" \
		"$testdir/pkg/linux-test-kernel-mainline/etc/deviceinfo"; then
		echo "ERROR: unexpected result with mainline deviceinfo"
		exit 1
	fi

	# Cleanup
	rm -r "$testdir"
}

package() {
	install -Dm755 "$srcdir/devicepkg_build.sh" \
		"$pkgdir/usr/bin/devicepkg_build"
	install -Dm755 "$srcdir/devicepkg_package.sh" \
		"$pkgdir/usr/bin/devicepkg_package"
	install -Dm755 "$srcdir/downstreamkernel_prepare.sh" \
		"$pkgdir/usr/bin/downstreamkernel_prepare"
	install -Dm755 "$srcdir/downstreamkernel_package.sh" \
		"$pkgdir/usr/bin/downstreamkernel_package"
	install -Dm755 "$srcdir/devicepkg_subpackage_kernel.sh" \
		"$pkgdir/usr/bin/devicepkg_subpackage_kernel"
	install -Dm755 "$srcdir/fragment_prepare.sh" \
		"$pkgdir/usr/bin/fragment_prepare"
	install -Dm644 "$srcdir/compiler-gcc.h" \
		"$pkgdir/usr/share/devicepkg-dev/compiler-gcc.h"
}
sha512sums="
d69930dd790b00fb39760a37d95a10899f0d167e10e2804feb05d9ce04f94185dc32d36edc90214aba2ea2aa09bf18f7dab93f1d2eff23f67beb2cc83be30e7c  compiler-gcc.h
801154d608c4bd22e9d4d8a80c07c500ae83c337ed710930ba11fd5d81fe2aafff8a74ce89aef46ce29da0716cf162692646e6e9a0b7cbc921d2707036811e8c  devicepkg_build.sh
74c1b9b265a943604d5d538ca66d4b7bcad9adcf40710ab19d795b55aac39669bf1089f7f0ec81aa7a01b537784bef4310e4acc3d7a6ba1f282ab01652bdc4d4  devicepkg_package.sh
90f3de0e6315ff1a55d06d85d095175831f9873cf94191531f55e0f5d2b4b0c14a5b49a26721449a1f16e466b44e2c58ed4c34b928bc0f93919f9ca97926ce26  downstreamkernel_prepare.sh
776d7c36afc7bedbd531641abe90fa4bf06a519ad9e300dedf67b6d3b4997b57a398938dd528d5eeda6d17e0d34644472702a4fdd8ff41e0a4a7ad0671f4a216  downstreamkernel_package.sh
cf5ee240cd1c1e9d30cdec833b4a007fd2e00f9a32ba3f265f99aa2e3dd3601cf43c08d3f3e01bade1d5b2648a6754b2f236e5cb4a9945e18e5c4e97aa2ed7c8  devicepkg_subpackage_kernel.sh
5d7d4b5e3986d83d129e7a2182c7b8cc112b6bd05f70aa027a7c8e426bdddeedd1346984984a9fc48fa1b081597ce43ce533a3fb928fe4622acc273880c7403a  fragment_prepare.sh
9bb7f2a0930f397a713e9f4b6d5b83a426d9a2a3f692dcc42ac30717bf26ead869d8823a38f3ad388af12b2b9a02e8ec4d4418e9c2062389ed06d2b891a49ff3  deviceinfo
136247a16ec91dc0c7241eeddb28c2196ae3b29946a9bc7e9566f848491ef1c53b12d05bf2dbc1cc352986712fd76f25c1510bcc8f301af540a2f01c33b299e1  expected-deviceinfo-downstream
8cdbf149e1bdfaf4d4a246a208732836956fd81a3aa01ef968e4c2e2cca4027f71cfc38e22debade83ddfca4e05267983c1c8a9c1aa9461a8cf493ef7e893097  expected-deviceinfo-mainline
"
