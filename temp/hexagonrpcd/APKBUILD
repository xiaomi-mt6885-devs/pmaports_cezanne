# Maintainer: Dylan Van Assche <me@dylanvanassche.be>
# Forked from Alpine: upgrade to 0.3.1
pkgname=hexagonrpcd
pkgver=0.3.1
pkgrel=0
pkgdesc="Qualcomm HexagonFS daemon"
url="https://gitlab.com/sdm670-mainline/hexagonrpc"
arch="all"
license="GPL-3.0-or-later"
makedepends="linux-headers meson"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"

source="https://gitlab.com/sdm670-mainline/hexagonrpc/-/archive/v$pkgver/hexagonrpc-v$pkgver.tar.gz
	noshared.patch
	0001_revert_hexagonfs.patch
	0002_hexagon_sysfs.patch
	10-fastrpc.rules
	$pkgname-adsp-rootpd.initd
	$pkgname-adsp-sensorspd.initd
	$pkgname-sdsp.initd
	$pkgname.confd
	"
builddir="$srcdir/hexagonrpc-v$pkgver"

build() {
	abuild-meson \
		-Db_lto=true \
		. output
	meson compile -C output
}

check() {
	meson test -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# Allow access for FastRPC node for FastRPC user/group
	install -Dm644 "$srcdir"/10-fastrpc.rules -t "$pkgdir"/usr/lib/udev/rules.d/

	install -Dm755 "$srcdir"/$pkgname-adsp-rootpd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-rootpd
	install -Dm755 "$srcdir"/$pkgname-adsp-sensorspd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-sensorspd
	install -Dm755 "$srcdir"/$pkgname-sdsp.initd "$pkgdir"/etc/init.d/$pkgname-sdsp
	install -Dm644 "$srcdir"/$pkgname.confd "pkgdir"/etc/conf.d/$pkgname-adsp-rootpd
	install -Dm644 "$srcdir"/$pkgname.confd "pkgdir"/etc/conf.d/$pkgname-adsp-sensorspd
	install -Dm644 "$srcdir"/$pkgname.confd "pkgdir"/etc/conf.d/$pkgname-sdsp
}


sha512sums="
ce2340457390c4ba7b7b6835004bf4f2aa80736716f77e13d523175e699c2a3405d31e684a38cc03093ba49ba951fbdc8cdd6513b2068925e0ab734bae9a06d3  hexagonrpc-v0.3.1.tar.gz
fd2a54e7725b271ed46eb8bc1360c55a544dd7c8ba8fad2d630407c98c68d9785454a3ac357098e6ce1582420969d95bad628c043e25f86781c3ede1321d36aa  noshared.patch
a32b0d958d86f40c46df3ba13023cf35e468a957ca1f55a2536ab52223de3ff10013a6b1fc49bff538f07b84f9393d53fcb8ea13408fe80674a9bc2ab730bc74  0001_revert_hexagonfs.patch
700f2a5fa2467fd8c5c62d06f7025b3988516ff1a60a9616b191d15230aed6564645bd041788fcc88b5802cf7aa9769c5a135dc7e823361608ead8930645d001  0002_hexagon_sysfs.patch
f931cf5f901a7c17ffb0eb194b5de2c532fd238692898bf264c484b13b93119c9727bd8f8daf6a7d1668cc9108a9a0662231d300c6f1376e3e4edd3ce41d235d  10-fastrpc.rules
de049c3d548bb146eaf2cadff01ae10eec41e8da72d955a808c0aca7f636fc4b4b3c47af350ccc15c7faf1811df45de14cdfe59e51b75e8a41edb5506ee59eb0  hexagonrpcd-adsp-rootpd.initd
c8bb68ea9402d84b84af0fcde65120774aa3f46db5a9fb7a3c0e711bcbc4ee01b03b8d10e4fdc7289277b6f3cc8351c06a21f28273b361de7947f761d69d0bcf  hexagonrpcd-adsp-sensorspd.initd
d1ad838d0484f6a41e0df12d3d55cd3f8029556fc44b470f6b3905da06afc8433ec77b5d18678dc9be9b375231b74382a897acba958bce1a9bb8eebc104371c1  hexagonrpcd-sdsp.initd
4585440ca34958b8a940d1979c8553ffa7e85710d79147c79e58ba1816bc9cd26c031f8fb50f113600854c3d914b03620d7a7b8f23446d5047efa9b8c80b45a5  hexagonrpcd.confd
"
