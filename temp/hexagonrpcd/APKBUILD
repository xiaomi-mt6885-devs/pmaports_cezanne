# Maintainer: Dylan Van Assche <me@dylanvanassche.be>
# Forked from Alpine: upgrade to 0.3.0
pkgname=hexagonrpcd
pkgver=0.3.0
pkgrel=0
pkgdesc="Qualcomm HexagonFS daemon"
url="https://gitlab.com/sdm670-mainline/hexagonrpc"
arch="all"
license="GPL-3.0-or-later"
makedepends="linux-headers meson"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"
source="https://gitlab.com/sdm670-mainline/hexagonrpc/-/archive/v$pkgver/hexagonrpc-v$pkgver.tar.gz
	noshared.patch
	10-fastrpc.rules
	$pkgname-adsp-rootpd.initd
	$pkgname-adsp-sensorspd.initd
	$pkgname-sdsp.initd
	"
builddir="$srcdir/hexagonrpc-v$pkgver"

build() {
	abuild-meson \
		-Db_lto=true \
		. output
	meson compile -C output
}

check() {
	meson test -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# Allow access for FastRPC node for FastRPC user/group
	install -Dm 644 "$srcdir"/10-fastrpc.rules -t "$pkgdir"/usr/lib/udev/rules.d/

	install -Dm755 "$srcdir"/$pkgname-adsp-rootpd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-rootpd
	install -Dm755 "$srcdir"/$pkgname-adsp-sensorspd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-sensorspd
	install -Dm755 "$srcdir"/$pkgname-sdsp.initd "$pkgdir"/etc/init.d/$pkgname-sdsp
}


sha512sums="
7d7f5a86e66f77136c26535e0b79a176608b494020c465b19049cbff1978f47e0c0da9ab79ba41f092a10d7f47207304ad458b5ddf57b7985ba9f1006fd762e9  hexagonrpc-v0.3.0.tar.gz
d20aca9bd5a757e0049d0fe5dbdcccdd95f0feb6910adc11b9c02e06d4e9ffae000a52781b1f7106dcabde05b5f2f3c1b65e8581f1393d75a6441094fcd818bd  noshared.patch
f931cf5f901a7c17ffb0eb194b5de2c532fd238692898bf264c484b13b93119c9727bd8f8daf6a7d1668cc9108a9a0662231d300c6f1376e3e4edd3ce41d235d  10-fastrpc.rules
ba4bf55ee1bde169617ef0b4b2aefc6472397f4a13bf6ff3c2dd5e582df903f617fd59abe00c8efeba458fb9eab5b69ed9a5303b3d9a7f02169d0cf39cbce849  hexagonrpcd-adsp-rootpd.initd
dc21318e817c4f6cf9192fc574fbc3b8e5e0a737e76277cb4f23aadac21f17a1b75648057afbcb20b5972072acf1cbecb6f4b3dda05ee6c046944f2e5f59cd8b  hexagonrpcd-adsp-sensorspd.initd
5a2000a3791dcae15ee3ac0c1721828de407ba77f3dd09401243afc9ecc3f9a82758c5d905aeb95e8f9dbab5b423dcd3a7aba42647b82a1c174d4aa5717a1951  hexagonrpcd-sdsp.initd
"
