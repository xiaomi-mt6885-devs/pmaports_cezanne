# Maintainer: Dylan Van Assche <me@dylanvanassche.be>
# Forked from Alpine: upgrade to 0.3.1
pkgname=hexagonrpcd
pkgver=0.3.1
pkgrel=6
pkgdesc="Qualcomm HexagonFS daemon"
url="https://gitlab.com/sdm670-mainline/hexagonrpc"
arch="all"
license="GPL-3.0-or-later"
makedepends="linux-headers meson"
install="$pkgname.pre-install"
subpackages="$pkgname-openrc"

source="https://gitlab.com/sdm670-mainline/hexagonrpc/-/archive/v$pkgver/hexagonrpc-v$pkgver.tar.gz
	noshared.patch
	0001_revert_hexagonfs.patch
	0002_hexagon_sysfs.patch
	10-fastrpc.rules
	$pkgname-adsp-rootpd.initd
	$pkgname-adsp-sensorspd.initd
	$pkgname-sdsp.initd
	"
builddir="$srcdir/hexagonrpc-v$pkgver"

build() {
	abuild-meson \
		-Db_lto=true \
		. output
	meson compile -C output
}

check() {
	meson test -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output

	# Allow access for FastRPC node for FastRPC user/group
	install -Dm 644 "$srcdir"/10-fastrpc.rules -t "$pkgdir"/usr/lib/udev/rules.d/

	install -Dm755 "$srcdir"/$pkgname-adsp-rootpd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-rootpd
	install -Dm755 "$srcdir"/$pkgname-adsp-sensorspd.initd "$pkgdir"/etc/init.d/$pkgname-adsp-sensorspd
	install -Dm755 "$srcdir"/$pkgname-sdsp.initd "$pkgdir"/etc/init.d/$pkgname-sdsp
}


sha512sums="
ce2340457390c4ba7b7b6835004bf4f2aa80736716f77e13d523175e699c2a3405d31e684a38cc03093ba49ba951fbdc8cdd6513b2068925e0ab734bae9a06d3  hexagonrpc-v0.3.1.tar.gz
fd2a54e7725b271ed46eb8bc1360c55a544dd7c8ba8fad2d630407c98c68d9785454a3ac357098e6ce1582420969d95bad628c043e25f86781c3ede1321d36aa  noshared.patch
a32b0d958d86f40c46df3ba13023cf35e468a957ca1f55a2536ab52223de3ff10013a6b1fc49bff538f07b84f9393d53fcb8ea13408fe80674a9bc2ab730bc74  0001_revert_hexagonfs.patch
700f2a5fa2467fd8c5c62d06f7025b3988516ff1a60a9616b191d15230aed6564645bd041788fcc88b5802cf7aa9769c5a135dc7e823361608ead8930645d001  0002_hexagon_sysfs.patch
f931cf5f901a7c17ffb0eb194b5de2c532fd238692898bf264c484b13b93119c9727bd8f8daf6a7d1668cc9108a9a0662231d300c6f1376e3e4edd3ce41d235d  10-fastrpc.rules
ba4bf55ee1bde169617ef0b4b2aefc6472397f4a13bf6ff3c2dd5e582df903f617fd59abe00c8efeba458fb9eab5b69ed9a5303b3d9a7f02169d0cf39cbce849  hexagonrpcd-adsp-rootpd.initd
dc21318e817c4f6cf9192fc574fbc3b8e5e0a737e76277cb4f23aadac21f17a1b75648057afbcb20b5972072acf1cbecb6f4b3dda05ee6c046944f2e5f59cd8b  hexagonrpcd-adsp-sensorspd.initd
5a2000a3791dcae15ee3ac0c1721828de407ba77f3dd09401243afc9ecc3f9a82758c5d905aeb95e8f9dbab5b423dcd3a7aba42647b82a1c174d4aa5717a1951  hexagonrpcd-sdsp.initd
"
